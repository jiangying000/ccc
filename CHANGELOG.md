# Changelog

## [1.10.1] - 2025-08-19

### Added
- **自动跳过权限检查**: 使用 `--resume` 时默认添加 `--dangerously-skip-permissions` 选项
  - 避免每次文件操作都需要确认权限
  - 在界面上提示用户已启用此选项
  - 提高恢复会话的效率

## [1.10.0] - 2025-08-19

### Added
- **页面跳转功能**: 按 `G` 键后输入页码直接跳转
  - 支持跳转到1-最大页码的任意页面
  - 输入页码后按Enter确认
  - 按ESC取消跳转
  - 支持Backspace删除输入

### Changed
- **每页显示数量**: 调整回3条（用户反馈4条太多）
- **数字加粗显示**: 消息数、token数、文件大小使用粗体

## [1.9.1] - 2025-08-19

### Changed
- **每页显示数量**: 从2条增加到4条，提高浏览效率
- **快捷键优化**: 上一页改用 `B` 键（Back），更符合直觉

### Fixed  
- **首次加载优化**: 从4秒减少到1秒以内
  - 不再读取整个文件到内存
  - 使用流式行计数替代readlines()
  - 延迟JSON解析到选中后

## [1.9.0] - 2025-08-19

### Changed
- **压缩策略重写**: 实现真正的"前25k + 后75k"策略
  - 前25k: 从会话开头提取消息，直到达到25k tokens
  - 后75k: 从会话末尾提取消息，直到达到75k tokens
  - 移除了原来的优先级策略（70%/30%分配）
- **超限处理**: 允许最后一条消息略微超过限制
  - 达到阈值时，仍然加上最后一条消息再停止
  - 避免因严格限制而截断重要信息

### Fixed
- **加载速度优化**: 从10秒减少到0.5秒以内
  - 首页会话使用快速扫描，只解析前后少量消息
  - 延迟加载：选中后才完整解析

## [1.8.2] - 2025-08-19

### Added
- **操作选择菜单**: 选择会话后让用户主动选择操作
  - [R] Resume - 直接恢复（< 150k tokens）
  - [C] Compress - 智能压缩
  - [B] Back - 返回会话列表
  - [Q] Quit - 退出
- **更好的用户控制**: 用户可以选择是否压缩小会话

### Changed
- **标题更新**: "Claude Code会话压缩和恢复工具"

### Fixed
- **代码缩进错误**: 修复了 extract_meaningful_messages 函数的缩进问题
- **skip_patterns 未定义错误**: 修复了条件定义变量导致的错误

## [1.8.0] - 2025-08-19

### Added
- **确认阶段**: 选择会话后显示详细预览和即将执行的操作
  - 显示是否使用 `--resume` 或压缩
  - 显示token数量和压缩比例
  - 让用户确认后再执行
- **更详细的会话预览**: 选中后显示更多对话内容

### Changed
- **HCI优化**: 应用CLI输出最佳实践
  - 每页从3个减少到2个会话，增加可读性
  - 增加空白和视觉层次
  - 简化统计信息显示
- **消息提取改进**: 
  - 优先显示用户对话和Claude回复
  - 过滤掉Tool调用等技术细节
  - 更清晰地区分用户和助手消息

### Fixed
- **界面混乱问题**: 移除了工具调用显示，专注于对话内容

## [1.7.0] - 2025-08-18

### Added
- **智能会话恢复**: 根据会话大小自动选择恢复方式
  - 小于 150k tokens：直接使用 `claude --resume` 恢复原始会话，保留100%上下文
  - 大于等于 150k tokens：执行智能压缩，提取关键信息
- **阈值设置**: 150k tokens 作为压缩阈值（Claude窗口200k，留50k余量）

### Changed
- **优化用户体验**: 小会话不再丢失任何上下文信息
- **更清晰的提示**: 显示会话大小和处理方式

## [1.6.5] - 2025-08-18

### Fixed
- **修复30个会话后显示0条的问题**: 实现了延迟加载机制
  - 初始只加载第一页（3个会话）
  - 翻页时动态加载当前页的会话信息
  - 其他会话保持基本信息（文件大小、消息数估算）
- **性能优化**: 启动速度更快，只在需要时加载会话详情

### Changed
- **简化代码逻辑**: 移除复杂的预加载策略，采用按需加载

## [1.6.4] - 2025-08-18

### Changed
- **每页显示数量优化**: 从5个减少到3个会话，每个会话显示更多细节
- **消息显示增加**: 
  - 开始消息从2条增加到3条
  - 最后消息从3条增加到4条
- **消息长度优化**: 显示完整200字符，不再使用首尾截断
- **更清晰的内容显示**: 每个会话有更多空间展示完整信息

### Removed  
- **移除搜索功能**: 由于存在bug且使用不便，暂时移除搜索功能

## [1.6.3] - 2025-08-18

### Changed
- **智能消息显示**: 对于超长消息（>160字符），显示前80字符 + ... + 后80字符
  - 避免单纯截断丢失重要信息
  - 让用户同时看到消息的开头和结尾
- **内部消息提取增强**: 从150字符增加到300字符，保留更完整的原始内容
- **摘要完整显示**: 不再截断Claude生成的摘要，让其完整显示

### Fixed
- **消息内容过于简略**: 采用首尾显示方式，让用户看到更有用的信息

## [1.6.2] - 2025-08-18

### Changed
- **每页显示数量**: 改回5个会话（1.6.1版本是3个）
- **最后消息显示增加**: 显示3条最后的消息（原1条），提供更多上下文
- **消息长度增加**: 从50字符增加到75字符，减少不必要的省略
- **内部消息提取**: 从100字符增加到150字符，保留更完整的内容

### Fixed
- **消息过度省略问题**: 增加显示长度，让用户看到更完整的消息内容

## [1.6.1] - 2025-08-18

### Changed
- **每页显示数量优化**: 从5个减少到3个，每个会话显示更多细节
- **会话ID显示**: 显示会话文件名前8位作为唯一标识，方便区分相似会话
- **消息内容增加**: 
  - 显示2条开始的消息（原1条）
  - 显示1条最后的消息
  - 提取消息数量增加到5条（原3条）
- **Git分支显示**: 在统计信息行直接显示Git分支
- **更好的相似会话区分**: 通过更多消息内容和会话ID帮助用户区分

### Fixed
- **相似会话难以区分**: 现在显示更多独特信息帮助识别

## [1.6.0] - 2025-08-18

### Added
- **分页浏览系统**: 全新的交互式UI，支持分页浏览大量会话
  - 默认每页显示5个会话（原来一次性显示10个）
  - `n` 键翻到下一页
  - `p` 键翻到上一页
  - `/` 键搜索会话（支持搜索摘要、主题、内容、Git分支）
  - `c` 键清除搜索
  - `0-4` 数字键选择当前页的会话
  - `q` 或 `ESC` 退出

### Changed
- **UI架构重构**: 将交互式UI拆分到独立模块 `interactive_ui.py`
- **性能优化**: 只预加载前30个会话的完整信息，其他按需加载
- **更紧凑的显示**: 每个会话只显示4行信息，更适合分页浏览

### Fixed
- **代码清理**: 移除了831行冗余的旧UI代码

## [1.5.4] - 2025-08-18

### Added
- **会话摘要显示**: 利用Claude生成的summary信息显示会话主题
- **Git分支显示**: 显示会话所在的Git分支
- **会话持续时间**: 显示会话从开始到结束的时间跨度
- **更智能的主题识别**: 结合summary信息更准确地识别会话主题
- **增加显示条数**: 默认显示最近10条会话（原来是5条）

### Changed
- **工具调用格式优化**: 简化工具调用显示，更易读
  - `执行命令: npm install` 替代 `[Tool: Bash] {'command': 'npm install'...}`
  - `读取文件: config.json` 替代 `[Tool: Read] {'file_path': '/path/to/config.json'...}`
- **内容去重改进**: 更智能的相似内容检测，避免重复显示
- **工具结果简化**: 成功/失败的工具结果用简洁图标表示

### Fixed
- **摘要提取**: 正确提取和使用会话中的summary消息
- **时间戳处理**: 正确解析ISO格式时间戳

## [1.5.3] - 2025-08-18

### Fixed
- **修复token计算严重错误**: 之前未正确提取thinking blocks、tool_use和tool_results内容
  - 修复前：94条消息只计算出536 tokens（实际只提取了15条有内容的消息）
  - 修复后：94条消息正确计算出3825 tokens（提取了88条有内容的消息）
- **改进内容提取**: `_get_message_content`方法现在正确处理所有消息类型
  - 支持thinking blocks（思考内容）
  - 支持tool_use（工具调用）
  - 支持tool_results（工具结果）

### Changed
- **更准确的token计算**: 现在包含所有类型的消息内容，不再漏算
- **更真实的会话信息**: 交互界面显示的token数量现在反映实际内容量

## [1.5.2] - 2025-08-18

### Fixed
- **修复选择后卡死问题**: 移除了capture_output，让Claude的输出直接显示给用户
- **修复token计算异常处理**: 改进了异常处理，避免单个消息计算失败导致整体失败
- **改进错误日志**: 添加了错误提示，帮助调试问题

### Changed
- **Claude启动提示**: 选择会话后显示"正在启动Claude..."提示
- **会话结束提示**: Claude退出后显示相应的状态信息

## [1.5.1] - 2025-08-18

### Fixed
- **Token计算准确性大幅提升**: 改进了估算算法，分别计算中文、英文单词和标点符号
- **Token显示格式**: 修复了小于1000的token显示为0k的问题，现在正确显示实际数值
- **ESC键退出**: 修复了ESC键在某些情况下无法退出的问题，并在回退模式下支持q退出

### Changed
- **Token估算算法**: 中文字符约1.5 tokens，英文单词约1.3 tokens，更接近实际值
- **异常处理**: 更精确的异常捕获，避免错误地回退到普通输入模式

## [1.5.0] - 2025-08-18

### Added
- **智能特征提取**: 根据关键词权重评分，显示最有特征的内容
- **关键词识别**: 识别bug、error、API、webhook、文件名等重要信息
- **问题和代码检测**: 优先显示包含问题和代码的内容

### Fixed
- **真正修复交互模式确认问题**: 确保选择会话后直接发送，不再需要二次确认
- **改进内容识别**: 跳过更多无意义的模板文本

## [1.4.1] - 2024-08-18

### Changed
- **移除交互模式确认**: 选择会话后直接发送，不再需要二次确认

## [1.4.0] - 2024-08-18

### Added
- 🎮 **ESC键支持**: 支持ESC键退出选择界面
- 📱 **窄屏优化**: 垂直布局，适应手机等窄屏设备
- 📝 **更多内容**: 显示最多3条开始和结束的对话

### Changed
- **简化布局**: 移除过长的横线，使用更简洁的分隔符
- **垂直排列**: 信息垂直排列，避免被截断
- **缩短行宽**: 每行最多50字符，适应窄屏

### Fixed
- 修复了窄屏幕下信息被截断的问题
- 修复了sys变量冲突的bug

## [1.3.0] - 2024-08-18

### Added
- 🎯 **智能消息提取**: 自动跳过"提取的对话上下文"等无意义信息
- 📝 **双重内容预览**: 同时显示开始和最后的消息，更容易识别会话
- ⏰ **相对时间显示**: 显示"刚刚"、"5分钟前"、"2小时前"等

### Changed
- **减少显示数量**: 从15个减少到5个最近会话（更聚焦）
- **优化界面布局**: 更清晰的信息层次，更易读
- **改进特征提取**: 智能识别并显示最有特征的对话内容

### Fixed
- 修复了大部分会话显示相同"提取的对话上下文"的问题
- 改进了消息内容识别算法

## [1.2.0] - 2024-08-18

### Added
- 📊 **丰富的会话信息**: 交互选择时显示更多信息
  - 文件大小（KB/MB）
  - 消息数量
  - Token估算
  - 第一条消息预览
- 🎯 **改进的交互界面**: 更清晰的会话选择器

### Changed
- **默认交互模式**: `ccdrc`无参数时直接进入选择界面
- **优化显示**: 最多显示15个最近会话
- **进度提示**: 读取会话信息时显示进度

## [1.1.0] - 2024-08-18

### Added
- ✅ **确认预览功能**: 发送到Claude前显示会话预览
  - 显示消息总数和token统计
  - 预览开头和结尾各3条消息
  - 提供确认/取消/重选选项
  - 避免误发送错误会话

### Changed
- 默认启用确认功能（简化使用）
- 改进CLI工作流程

## [1.0.0] - 2024-08-18

### Initial Release
- 🚀 智能提取Claude对话上下文
- 🎯 多种压缩策略
- ⚡ 支持多种安装方式（pipx/uvx/pip）
- 📊 精确token计算（tiktoken）
- 🔒 完全隔离环境