# Token计算偏差修复说明

## 问题描述
之前CCDRC显示提取了139k tokens，但Claude API报错显示实际输入190k tokens，存在37%的偏差。

## 问题原因
1. **只计算内容本身**：之前只计算了消息内容的tokens
2. **忽略格式化开销**：没有计算角色标记、分隔符、Markdown格式等
3. **忽略系统开销**：Claude的JSON结构、系统消息等额外开销

## 解决方案

### 1. 引入开销系数
```python
OVERHEAD_FACTOR = 0.6  # 实际可用tokens约为目标的60%
```

### 2. 调整提取策略
- 用户指定：前25k + 后75k
- 实际提取：前15k + 后45k（60%）
- 预估实际：~100k tokens（含格式化）

### 3. 显示预估值
现在会显示两个值：
- **提取内容**：纯内容的tokens
- **预估实际**：包含格式化后的预估tokens

## 使用建议

### 安全的分配策略

| 场景 | 输入 | 实际内容 | 预估总量 |
|------|------|----------|----------|
| 保守策略 | 20 40 | 12k+24k | ~60k |
| 标准策略 | 25 75 | 15k+45k | ~100k |
| 激进策略 | 30 90 | 18k+54k | ~120k |
| 最大策略 | 40 100 | 24k+60k | ~140k |

### 警告阈值
- **<150k**: ✅ 安全
- **150k-180k**: ⚠ 注意
- **>180k**: ⚠️ 警告，接近200k限制

## 测试方法

```bash
# 运行测试脚本
python3 /home/jy/gitr/jiangying000/ccdrc/test_token_accuracy.py
```

## 实际使用

```bash
ccdrc
```

选择压缩时，注意新的显示：
```
📊 压缩统计:
  策略: 前25k + 后75k tokens
  原始: 523条消息, 186,432 tokens
  提取: 187条消息, 59,876 tokens
  预估实际: ~99,793 tokens (含格式化开销)
  压缩率: 67.9%
```

## 技术细节

### 格式化开销包括
1. **角色标记**：每条消息的`**👤 用户**:` 或 `**🤖 Claude**:`
2. **分隔符**：消息之间的`\n\n`
3. **Markdown**：头部和尾部的说明文字
4. **系统消息**：Claude的内部系统提示
5. **JSON结构**：消息的元数据

### 计算公式
```
实际tokens ≈ 内容tokens / 0.6
```

这个系数基于实际测试：
- 139k内容 → 190k实际 = 1.37倍
- 保守估计使用1.67倍（1/0.6）

## 更新记录
- **v3.9.1**: 修复token计算偏差
  - 引入OVERHEAD_FACTOR = 0.6
  - 显示预估实际tokens
  - 添加安全警告